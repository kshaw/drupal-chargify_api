<?php
// $Id$

/**
 * @file
 *   Chargify API Module.
 *
 *   Built by Sprocket.
 *   http://sprocketcreative.com
 */

define('CHARGIFY_API_TRIALING', 'trialing');
define('CHARGIFY_API_ACTIVE', 'active');
define('CHARGIFY_API_SOFT_FAILURE', 'soft_failure');
define('CHARGIFY_API_PAST_DUE', 'past_due');
define('CHARGIFY_API_SUSPENDED', 'suspended');
define('CHARGIFY_API_CLOSED', 'closed');
define('CHARGIFY_API_EXPIRED', 'expired');

/**
 * Implementation of hook_menu().
 */
function chargify_api_menu() {
  $items = array();

  $items['admin/settings/chargify'] = array(
    'title' => 'Chargify',
    'description' => 'Configure Chargify settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('chargify_api_settings_form'),
    'access arguments' => array('administer chargify'),
  );

  if (function_exists('json_decode')) {
    $items['chargify-postback'] = array(
      'page callback' => 'chargify_api_chargify_postback',
      'type' => MENU_CALLBACK,
      'access callback' => TRUE,
    );
  }

  return $items;
}

/**
 * Implementation of hook_perm().
 */
function chargify_api_perm() {
  return array('administer chargify');
}

/**
 * Configuration settings form.
 */
function chargify_api_settings_form() {
  $form = array();

  $form['chargify_api_payment_page_hosted_path'] = array(
    '#type' => 'textfield',
    '#title' => t('Chargify Hosted Payment Page'),
    '#default_value' => variable_get('chargify_api_payment_page_hosted_path', ''),
  );

  $test_mode = variable_get('chargify_api_test_mode', TRUE);

  $form['test'] = array(
    '#type' => 'fieldset',
    '#title' => t('Test mode'),
    '#collapsible' => TRUE,
    '#collapsed' => !$test_mode,
  );
  $form['test']['chargify_api_test_mode'] = array(
    '#type' => 'checkbox',
    '#title' => t('Test Mode'),
    '#default_value' => $test_mode,
  );
  $form['test']['chargify_api_test_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('Test API Key'),
    '#default_value' => variable_get('chargify_api_test_api_key', ''),
  );
  $form['test']['chargify_api_test_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Test domain'),
    '#default_value' => variable_get('chargify_api_test_domain', ''),
  );

  $form['live'] = array(
    '#type' => 'fieldset',
    '#title' => t('Live mode'),
    '#collapsible' => TRUE,
    '#collapsed' => $test_mode,
  );
  $form['live']['chargify_api_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('API Key'),
    '#default_value' => variable_get('chargify_api_api_key', ''),
  );
  $form['live']['chargify_api_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Domain'),
    '#default_value' => variable_get('chargify_api_domain', ''),
  );

  return system_settings_form($form);
}

/**
 * Page callback for chargify-postback.
 */
function chargify_api_chargify_postback() {
  $json = file_get_contents("php://input");
  if (($customers = json_decode($json)) && is_array($customers)) {
    foreach ($customers as $customer_id) {
      chargify_api_customer_update($customer_id);
    }
  }
}

/**
 * Include Chargify includes.
 */
function chargify_api_include($file) {
  static $included = array();

  if (!isset($included[$file])) {
    module_load_include('inc', 'chargify_api', "includes/$file");
  }

  $included[$file] = TRUE;
}

/**
 * Include Chargify API wrapper class.
 */
function chargify_api_include_api() {
  static $finished = FALSE;

  if ($finished) {
    return;
  }

  $files = array('chargify_connector', 'chargify_credit_card', 'chargify_customer', 'chargify_product', 'chargify_subscription');

  foreach ($files as $file) {
    chargify_api_include($file);
  }

  $finished = TRUE;
}

/**
 * Start a new Chargify Connection.
 */
function chargify_api_new_connector() {
  chargify_api_include_api();

  return new chargify_connector();
}

/**
 * Update a customer, pulling data from Chargify.
 */
function chargify_api_customer_update($customer_id) {
  $chargify = chargify_api_new_connector();
}